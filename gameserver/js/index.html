<!DOCTYPE html>
<html>
    <head>
        <title>Block Escape</title>
    </head>
    <style type="text/css">
    p {
        height:25px;
        align:middle;
        font-family: monospace;
        text-align: center;
    }
    .titleText {
        font-family: monospace;
        font-size: 5em;
        text-align: center;
    }
    .textbox {
        width:130px;
    }
    .button {
        width:130px;
    }
    .table {
        width:270px;
        margin:0 auto;
        visibility:visible;
    }
    .buttontable {
        width:270px;
        margin:0 auto;
        display:none;
    }
    .column {
        float:left;
        width:50%;
    }
    .wrapper {
        position:absolute;
        left:490px;
        top:240px;
        width:300px;
        height:300px;
        text-align:center;
    }
    #singleCanvas {
        width:300px;
        height:300px;
        display:inline;
        background:#ffffff;
    }
    canvas {
        display: inline;
    }
    #error {
        width:100%;
        clear:both;
        text-align: center;
        display: none;
    }
    </style>
    <body>
    <div class="titleText">Block Escape</div>
    <div class="table" id="maintable">
        <div class="column">
                <p>
                Username <br /> 
                </p><p>
                Password <br /> 
                </p><p>
                <input class="button" id="createBtn" type="button" value="Create Account">
                </p>
        </div>
        <div class="column">
                <p>
                <input class="textbox" id="usernameTxt" type="text"> <br />
                </p><p>
                <input class="textbox" id="passwordTxt" type="password"><br />
                </p><p>
                <input class="button" id="loginBtn" type="button" value="Login">
                </p>
        </div>
    </div>
    <div class="buttontable" id="btnTable">
        <div class="column">
                <p></p>
                <input class="button" id="singleBtn" type="button" value="Singleplayer Mode">
        </div>
        <div class="column">
                <p></p>
                <input class="button" id="multiBtn" type="button" value="Multiplayer Mode">
        </div>
    </div>
    <div id="error">Error Logging In/Creating Account</div>
    <div class="wrapper">
        <canvas id="singleCanvas" width="0px" height="0px" display="inline"></canvas>
    </div>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ocanvas/2.7.3/ocanvas.min.js"></script>
    <script src="./sha256.js"></script>
    <script>
        var websocket = new WebSocket("ws://173.60.61.234:9003");
        var canvas;
        var rectangle;
        var mx = 0;
        var my = 0;
        var md = 0;
        var objects = [];
        var types = [];
        var numObjects = 0;
        var newInput = 0;
        var clientId = -1;
        var message = '';
        onload = init;

        function isMessage(startsWith, msg){
            if(msg.substring(0, startsWith.length) === startsWith){
                return true;
            }
            return false;
        }
        function getPayload(startsWith, msg){
            return msg.substring(startsWith.length, msg.length);
        }
        function onCreateClick() {
            document.getElementById("error").style.display = "none";
            websocket.send("ask salt username" + 
                document.getElementById("usernameTxt").value);
        }
        function onLoginClick() {
            document.getElementById("error").style.display = "none";
            websocket.send("ask salts username" + 
                document.getElementById("usernameTxt").value);
        }
        function setupMessages() {
            websocket.onmessage = function(evt){
                if(isMessage("get salt username", evt.data)){
                    salt = getPayload('get salt username', evt.data);
                    phash = SHA256.hash(salt + 
                        document.getElementById('passwordTxt').value);
                    websocket.send("create user " + 
                        document.getElementById("usernameTxt").value
                        + ' ' + phash);
                }
                if(isMessage("get salts username", evt.data)){
                    payload = getPayload('get salts username', evt.data);
                    salts=payload.split(/[ ,]+/);
                    phash = SHA256.hash(salts[1] + SHA256.hash(salts[0] + 
                        document.getElementById('passwordTxt').value));
                    websocket.send("login " + 
                        document.getElementById("usernameTxt").value
                        + ' ' + phash);
                }
                if(isMessage('login', evt.data)){
                    payload = getPayload('login', evt.data);
                    message=payload.split(/[ ,]+/);
                    if(message[0]=="fail"){
                        document.getElementById("error").style.display = "block";
                    }
                    else {
                        document.getElementById("maintable").style.display = "none";
                        document.getElementById("btnTable").style.display = "block";
                        init2();
                        if(clientId == -1) {
                            clientId = +payload;
                        }
                    }
                }
                if(isMessage('num pieces', evt.data)){
                    payload = getPayload('num pieces', evt.data);
                    message=payload.split(/[ ,]+/);
                    if(+message[0]==clientId) {
                        initObjects(+message[1]);
                    }
                }
                if(isMessage('draw pieces', evt.data)){
                    payload = getPayload('draw pieces', evt.data);
                    rect=payload.split(/[ ,]+/);
                    //check id before u do any draws
                    if(+rect[0]==clientId){
                        for(var i=0;i<numObjects;i++) {
                            if(+rect[i*6+1]==0){//0 is player piece type
                                objects[i].fill="#707";
                            }
                            else{
                                objects[i].fill="#077";
                            }
                            objects[i].x = +rect[i*6+2];
                            objects[i].y = +rect[i*6+3];
                            objects[i].width = +rect[i*6+4];
                            objects[i].height = +rect[i*6+5];
                            if(objects[i].width == 0){
                                objects[i].stroke="0px";
                            }
                            else{
                                objects[i].stroke="inside 1px rgba(220, 220, 220, 1)";
                            }
                        }
                    }
                }
            }
        }
        function init() {
            document.getElementById("createBtn").onclick = onCreateClick;
            document.getElementById("loginBtn").onclick = onLoginClick;
            setupMessages();
        }

        function init2() {
            document.getElementById("singleCanvas").width="300";
            document.getElementById("singleCanvas").height="300";
            canvas = oCanvas.create({
                canvas: "#singleCanvas"
            });
            canvas.addChild(canvas.display.rectangle({
                x: 0,
                y: 0,
                width: 300,
                height: 300,
                zIndex: 0,
                fill: "#990"
            }));
            for(var i=0;i<=300;i+=50){
                canvas.addChild(canvas.display.line({
                    start: {x:0, y:i},
                    end: {x:300, y:i},
                    zIndex: 1,
                    stroke: "1px rgba(128, 128, 128, 1)"
                }));
                canvas.addChild(canvas.display.line({
                    start: {x:i, y:0},
                    end: {x:i, y:300},
                    zIndex: 1,
                    stroke: "1px rgba(128, 128, 128, 1)"
                }));
            }

            inputLoop();
            canvas.setLoop(inputLoop).start();
        }
        function initObjects(numberOfObjects) {
            for(var i=0;i<numberOfObjects;i++) {
                addObject();
            }
        }
        function addObject() {
            rectangle = canvas.display.rectangle({
            x: 0,
            y: 0,
            width: 100,
            height: 50,
            fill: "#077"
            });
            objects.push(rectangle);
            numObjects = objects.length;
            canvas.addChild(rectangle);
        }

        var temp_x;
        function inputLoop() {
            if(clientId!=-1){
                if(canvas.mouse.buttonState=="up"&&md==1){
                    md=0;
                    newInput=1;
                }
                if(canvas.mouse.buttonState=="down"&&md==0){
                    md=1;
                    newInput=1;
                }
                if(canvas.mouse.x!=mx||canvas.mouse.y!=my){ 
                    mx=canvas.mouse.x;
                    my=canvas.mouse.y;
                    newInput=1;
                }
                if(newInput == 1){
                    newInput = 0;
                    message = clientId + ' ' + md + ' ' + mx + ' ' + my;
                    websocket.send('mouse input' + message);
                }
            }
        }

        </script>
</html>
