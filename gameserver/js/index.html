<!DOCTYPE html>
<html>
    <head>
        <title>BlockEscape</title>
        <style>
            * {margin:0;padding:0;}
            body {background:#ffffff;margin:0;padding:0;overflow:hidden;}
            #myCanvas {position:absolute;left:0;top:0;width:600;height:600;background:#ffffff;}
        </style>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/ocanvas/2.7.3/ocanvas.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
        <script>
            var socket = io('http://localhost:9002');
            var canvas;
            var rectangle;
            var mx = 0;
            var my = 0;
            var md = 0;
            var objects = [];
            var types = [];
            var numObjects = 0;
            var newInput = 0;
            var clientId = -1;
            var piecesInitialized = 0;
            var message = '';

            onload = init;

            function init() {
                socket.emit('assign me id');
                socket.on('assign id to html',function(newid) {
                if(clientId == -1)
                { 
                   clientId = parseInt(newid,10);
                   socket.emit('output id',clientId.toString());
                }
            });
                canvas = oCanvas.create({
                    canvas: "#myCanvas"
                });
                canvas.addChild(canvas.display.rectangle({
                    x: 0,
                    y: 0,
                    width: 600,
                    height: 600,
                    zIndex: 0,
                    fill: "#990"
                }));
                for(var i=0;i<=600;i+=100){
                    canvas.addChild(canvas.display.line({
                        start: {x:0, y:i},
                        end: {x:600, y:i},
                        zIndex: 1,
                        stroke: "1px rgba(128, 128, 128, 1)"
                    }));
                    canvas.addChild(canvas.display.line({
                        start: {x:i, y:0},
                        end: {x:i, y:600},
                        zIndex: 1,
                        stroke: "1px rgba(128, 128, 128, 1)"
                    }));
                }
                inputLoop();
                canvas.setLoop(inputLoop).start();
            }
            function initObjects(numberOfObjects) {
                for(var i=0;i<numberOfObjects;i++) {
                    addObject();
                }
            }
            function addObject() {
                rectangle = canvas.display.rectangle({
                x: 0,
                y: 0,
                width: 200,
                height: 100,
                fill: "#077"
                });
                objects.push(rectangle);
                numObjects = objects.length;
                canvas.addChild(rectangle);
            }

            var temp_x;
            function inputLoop() {
                if(canvas.mouse.buttonState=="up"&&md==1){
                    md=0;
                    newInput=1;
                }
                if(canvas.mouse.buttonState=="down"&&md==0){
                    md=1;
                    newInput=1;
                }
                if(canvas.mouse.x!=mx||canvas.mouse.y!=my){ 
                    mx=canvas.mouse.x;
                    my=canvas.mouse.y;
                    newInput=1;
                }
                if(newInput == 1){
                    newInput = 0;
                    message = '';
                    message = md + ' ' + mx + ' ' + my;
                    socket.emit('mouse input', clientId.toString() + ' ' + message);
                }
            }

            socket.on('num pieces', function(msg){
                if(piecesInitialized == 0)
                {
                    initObjects(+msg);
                    piecesInitialized = 1;
                }
            });

            
            socket.on('draw pieces', function(msg){
                rect=msg.split(/[ ,]+/);
                //check id before u do any draws
                for(var i=0;i<numObjects;i++) {
                    if(+rect[i*6]==clientId){
                        if(+rect[i*6+1]==0){//1 is player piece type
                            objects[i].fill="#707";
                        }
                        else{
                            objects[i].fill="#077";
                        }
                        objects[i].x = +rect[i*6+2];
                        objects[i].y = +rect[i*6+3];
                        objects[i].width = +rect[i*6+4];
                        objects[i].height = +rect[i*6+5];
                        if(objects[i].width == 0){
                            objects[i].stroke="0px";
                        }
                        else{
                            objects[i].stroke="inside 1px rgba(220, 220, 220, 1)";
                        }
                    }
                }
            });


        </script>
    </head>
    <body>
        <canvas id="myCanvas" width="600" height="600"></canvas>
    </body>
</html>
