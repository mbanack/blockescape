<!DOCTYPE html>
<html>
    <head>
        <title>BlockEscape</title>
        <style>
            * {margin:0;padding:0;}
            body {background:#ffffff;margin:0;padding:0;overflow:hidden;}
            #myCanvas {position:absolute;left:0;top:0;width:600;height:600;background:#ffffff;}
        </style>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/ocanvas/2.7.3/ocanvas.min.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
        <script>
            var socket = io('http://localhost:9002');
            var canvas;
            var rectangle;
            var mx = 0;
            var my = 0;
            var md = 0;
            var objects = [];
            var numObjects = 0;
            var newInput = 0;

            onload = init;

            function init() {
                canvas = oCanvas.create({
                    canvas: "#myCanvas"
                });
                canvas.addChild(canvas.display.rectangle({
                    x: 0,
                    y: 0,
                    width: 600,
                    height: 600,
                    zIndex: 0,
                    fill: "#990"
                }));
                for(var i=0;i<=600;i+=100){
                    canvas.addChild(canvas.display.line({
                        start: {x:0, y:i},
                        end: {x:600, y:i},
                        zIndex: 1,
                        stroke: "1px rgba(128, 128, 128, 1)"
                    }));
                    canvas.addChild(canvas.display.line({
                        start: {x:i, y:0},
                        end: {x:i, y:600},
                        zIndex: 1,
                        stroke: "1px rgba(128, 128, 128, 1)"
                    }));
                }
                canvas.bind("mousedown", function () {
                    md=1;
                    newInput=1;
                });
                canvas.bind("mouseup", function () {
                    md=0;
                    newInput=1;
                });
                canvas.setLoop(inputLoop).start();
            }
            function initObjects(numberOfObjects) {
                for(var i=0;i<numberOfObjects;i++) {
                    addObject();
                }
            }
            function addObject() {
                rectangle = canvas.display.rectangle({
                x: 0,
                y: 0,
                width: 200,
                height: 100,
                fill: "#077",
                stroke: "inside 1px rgba(220, 220, 220, 1)"
                });
                objects.push(rectangle);
                numObjects = objects.length;
                canvas.addChild(rectangle);
            }

            function inputLoop() {
               if(canvas.mouse.onCanvas()==false&&md==1){
                    md=0;
                    newInput=1;
               }
               if(canvas.mouse.x!=mx||canvas.mouse.y!=my){ 
                    mx=canvas.mouse.x;
                    my=canvas.mouse.y;
                    newInput=1;
                }
                if(newInput == 1){
                    newInput = 0;
                    message = md + ' ' + mx + ' ' + my;
                    socket.emit('mouse input', message);
                }
            }

            socket.on('num pieces', function(msg){
                initObjects(+msg);
                console.log(+msg);
            });

            socket.on('draw pieces', function(msg){
                rect=msg.split(/[ ,]+/);
                for(var i=0;i<numObjects;i++) {
                    objects[i].x = +rect[i*4];
                    objects[i].y = +rect[i*4+1];
                    objects[i].width = +rect[i*4+2];
                    objects[i].height = +rect[i*4+3];
                    if(objects[i].width == 0){
                        objects[i].stroke="inside: 0px";
                    }
                }
            });
        </script>
    </head>
    <body>
        <canvas id="myCanvas" width="600" height="600"></canvas>
        <pre>asdf</pre>
    </body>
</html>
